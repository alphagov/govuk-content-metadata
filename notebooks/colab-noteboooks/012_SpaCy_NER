{"cells":[{"cell_type":"markdown","metadata":{"id":"_BGkg8TDDqZY"},"source":["# Off the shelf NER models"]},{"cell_type":"markdown","metadata":{"id":"CLqcq8RODRjQ"},"source":["This notebook utilises off the shelf NER models to identify named entities within text. The goal is to qualitatively examine their ability to identify and correctly label entities containing language specific to the gov.uk domain."]},{"cell_type":"code","execution_count":null,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"elapsed":5,"status":"ok","timestamp":1639669302477,"user":{"displayName":"Jake Rutherford","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"06919904590009580026"},"user_tz":0},"id":"k-y8IuKaCE1U","outputId":"e5c32330-4ab9-494d-faa1-ab6a1d6c029f"},"outputs":[{"output_type":"stream","name":"stdout","text":["nvcc: NVIDIA (R) Cuda compiler driver\n","Copyright (c) 2005-2020 NVIDIA Corporation\n","Built on Mon_Oct_12_20:09:46_PDT_2020\n","Cuda compilation tools, release 11.1, V11.1.105\n","Build cuda_11.1.TC455_06.29190527_0\n"]}],"source":["!nvcc --version"]},{"cell_type":"code","execution_count":null,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"elapsed":25804,"status":"ok","timestamp":1639669328790,"user":{"displayName":"Jake Rutherford","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"06919904590009580026"},"user_tz":0},"id":"JD3tyJ2z-HcP","outputId":"d147a108-728e-453b-913b-3142697de192"},"outputs":[{"output_type":"stream","name":"stdout","text":["Requirement already satisfied: spacy in /usr/local/lib/python3.7/dist-packages (2.2.4)\n","Collecting spacy\n","  Downloading spacy-3.2.1-cp37-cp37m-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (6.0 MB)\n","\u001b[K     |████████████████████████████████| 6.0 MB 5.2 MB/s \n","\u001b[?25hRequirement already satisfied: murmurhash<1.1.0,>=0.28.0 in /usr/local/lib/python3.7/dist-packages (from spacy) (1.0.6)\n","Collecting catalogue<2.1.0,>=2.0.6\n","  Downloading catalogue-2.0.6-py3-none-any.whl (17 kB)\n","Collecting langcodes<4.0.0,>=3.2.0\n","  Downloading langcodes-3.3.0-py3-none-any.whl (181 kB)\n","\u001b[K     |████████████████████████████████| 181 kB 39.4 MB/s \n","\u001b[?25hRequirement already satisfied: requests<3.0.0,>=2.13.0 in /usr/local/lib/python3.7/dist-packages (from spacy) (2.23.0)\n","Requirement already satisfied: tqdm<5.0.0,>=4.38.0 in /usr/local/lib/python3.7/dist-packages (from spacy) (4.62.3)\n","Collecting pathy>=0.3.5\n","  Downloading pathy-0.6.1-py3-none-any.whl (42 kB)\n","\u001b[K     |████████████████████████████████| 42 kB 1.4 MB/s \n","\u001b[?25hRequirement already satisfied: setuptools in /usr/local/lib/python3.7/dist-packages (from spacy) (57.4.0)\n","Collecting spacy-legacy<3.1.0,>=3.0.8\n","  Downloading spacy_legacy-3.0.8-py2.py3-none-any.whl (14 kB)\n","Collecting thinc<8.1.0,>=8.0.12\n","  Downloading thinc-8.0.13-cp37-cp37m-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (628 kB)\n","\u001b[K     |████████████████████████████████| 628 kB 882 kB/s \n","\u001b[?25hCollecting srsly<3.0.0,>=2.4.1\n","  Downloading srsly-2.4.2-cp37-cp37m-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (451 kB)\n","\u001b[K     |████████████████████████████████| 451 kB 39.3 MB/s \n","\u001b[?25hCollecting typer<0.5.0,>=0.3.0\n","  Downloading typer-0.4.0-py3-none-any.whl (27 kB)\n","Requirement already satisfied: blis<0.8.0,>=0.4.0 in /usr/local/lib/python3.7/dist-packages (from spacy) (0.4.1)\n","Requirement already satisfied: wasabi<1.1.0,>=0.8.1 in /usr/local/lib/python3.7/dist-packages (from spacy) (0.8.2)\n","Collecting pydantic!=1.8,!=1.8.1,<1.9.0,>=1.7.4\n","  Downloading pydantic-1.8.2-cp37-cp37m-manylinux2014_x86_64.whl (10.1 MB)\n","\u001b[K     |████████████████████████████████| 10.1 MB 17.6 MB/s \n","\u001b[?25hRequirement already satisfied: cymem<2.1.0,>=2.0.2 in /usr/local/lib/python3.7/dist-packages (from spacy) (2.0.6)\n","Requirement already satisfied: typing-extensions<4.0.0.0,>=3.7.4 in /usr/local/lib/python3.7/dist-packages (from spacy) (3.10.0.2)\n","Requirement already satisfied: packaging>=20.0 in /usr/local/lib/python3.7/dist-packages (from spacy) (21.3)\n","Collecting spacy-loggers<2.0.0,>=1.0.0\n","  Downloading spacy_loggers-1.0.1-py3-none-any.whl (7.0 kB)\n","Requirement already satisfied: numpy>=1.15.0 in /usr/local/lib/python3.7/dist-packages (from spacy) (1.19.5)\n","Requirement already satisfied: jinja2 in /usr/local/lib/python3.7/dist-packages (from spacy) (2.11.3)\n","Requirement already satisfied: preshed<3.1.0,>=3.0.2 in /usr/local/lib/python3.7/dist-packages (from spacy) (3.0.6)\n","Requirement already satisfied: zipp>=0.5 in /usr/local/lib/python3.7/dist-packages (from catalogue<2.1.0,>=2.0.6->spacy) (3.6.0)\n","Requirement already satisfied: pyparsing!=3.0.5,>=2.0.2 in /usr/local/lib/python3.7/dist-packages (from packaging>=20.0->spacy) (3.0.6)\n","Requirement already satisfied: smart-open<6.0.0,>=5.0.0 in /usr/local/lib/python3.7/dist-packages (from pathy>=0.3.5->spacy) (5.2.1)\n","Requirement already satisfied: certifi>=2017.4.17 in /usr/local/lib/python3.7/dist-packages (from requests<3.0.0,>=2.13.0->spacy) (2021.10.8)\n","Requirement already satisfied: chardet<4,>=3.0.2 in /usr/local/lib/python3.7/dist-packages (from requests<3.0.0,>=2.13.0->spacy) (3.0.4)\n","Requirement already satisfied: urllib3!=1.25.0,!=1.25.1,<1.26,>=1.21.1 in /usr/local/lib/python3.7/dist-packages (from requests<3.0.0,>=2.13.0->spacy) (1.24.3)\n","Requirement already satisfied: idna<3,>=2.5 in /usr/local/lib/python3.7/dist-packages (from requests<3.0.0,>=2.13.0->spacy) (2.10)\n","Requirement already satisfied: click<9.0.0,>=7.1.1 in /usr/local/lib/python3.7/dist-packages (from typer<0.5.0,>=0.3.0->spacy) (7.1.2)\n","Requirement already satisfied: MarkupSafe>=0.23 in /usr/local/lib/python3.7/dist-packages (from jinja2->spacy) (2.0.1)\n","Installing collected packages: catalogue, typer, srsly, pydantic, thinc, spacy-loggers, spacy-legacy, pathy, langcodes, spacy\n","  Attempting uninstall: catalogue\n","    Found existing installation: catalogue 1.0.0\n","    Uninstalling catalogue-1.0.0:\n","      Successfully uninstalled catalogue-1.0.0\n","  Attempting uninstall: srsly\n","    Found existing installation: srsly 1.0.5\n","    Uninstalling srsly-1.0.5:\n","      Successfully uninstalled srsly-1.0.5\n","  Attempting uninstall: thinc\n","    Found existing installation: thinc 7.4.0\n","    Uninstalling thinc-7.4.0:\n","      Successfully uninstalled thinc-7.4.0\n","  Attempting uninstall: spacy\n","    Found existing installation: spacy 2.2.4\n","    Uninstalling spacy-2.2.4:\n","      Successfully uninstalled spacy-2.2.4\n","Successfully installed catalogue-2.0.6 langcodes-3.3.0 pathy-0.6.1 pydantic-1.8.2 spacy-3.2.1 spacy-legacy-3.0.8 spacy-loggers-1.0.1 srsly-2.4.2 thinc-8.0.13 typer-0.4.0\n","Requirement already satisfied: spacy[cuda111,transformers] in /usr/local/lib/python3.7/dist-packages (3.2.1)\n","Requirement already satisfied: tqdm<5.0.0,>=4.38.0 in /usr/local/lib/python3.7/dist-packages (from spacy[cuda111,transformers]) (4.62.3)\n","Requirement already satisfied: thinc<8.1.0,>=8.0.12 in /usr/local/lib/python3.7/dist-packages (from spacy[cuda111,transformers]) (8.0.13)\n","Requirement already satisfied: pathy>=0.3.5 in /usr/local/lib/python3.7/dist-packages (from spacy[cuda111,transformers]) (0.6.1)\n","Requirement already satisfied: jinja2 in /usr/local/lib/python3.7/dist-packages (from spacy[cuda111,transformers]) (2.11.3)\n","Requirement already satisfied: numpy>=1.15.0 in /usr/local/lib/python3.7/dist-packages (from spacy[cuda111,transformers]) (1.19.5)\n","Requirement already satisfied: spacy-loggers<2.0.0,>=1.0.0 in /usr/local/lib/python3.7/dist-packages (from spacy[cuda111,transformers]) (1.0.1)\n","Requirement already satisfied: wasabi<1.1.0,>=0.8.1 in /usr/local/lib/python3.7/dist-packages (from spacy[cuda111,transformers]) (0.8.2)\n","Requirement already satisfied: catalogue<2.1.0,>=2.0.6 in /usr/local/lib/python3.7/dist-packages (from spacy[cuda111,transformers]) (2.0.6)\n","Requirement already satisfied: cymem<2.1.0,>=2.0.2 in /usr/local/lib/python3.7/dist-packages (from spacy[cuda111,transformers]) (2.0.6)\n","Requirement already satisfied: setuptools in /usr/local/lib/python3.7/dist-packages (from spacy[cuda111,transformers]) (57.4.0)\n","Requirement already satisfied: spacy-legacy<3.1.0,>=3.0.8 in /usr/local/lib/python3.7/dist-packages (from spacy[cuda111,transformers]) (3.0.8)\n","Requirement already satisfied: langcodes<4.0.0,>=3.2.0 in /usr/local/lib/python3.7/dist-packages (from spacy[cuda111,transformers]) (3.3.0)\n","Requirement already satisfied: blis<0.8.0,>=0.4.0 in /usr/local/lib/python3.7/dist-packages (from spacy[cuda111,transformers]) (0.4.1)\n","Requirement already satisfied: murmurhash<1.1.0,>=0.28.0 in /usr/local/lib/python3.7/dist-packages (from spacy[cuda111,transformers]) (1.0.6)\n","Requirement already satisfied: typing-extensions<4.0.0.0,>=3.7.4 in /usr/local/lib/python3.7/dist-packages (from spacy[cuda111,transformers]) (3.10.0.2)\n","Requirement already satisfied: typer<0.5.0,>=0.3.0 in /usr/local/lib/python3.7/dist-packages (from spacy[cuda111,transformers]) (0.4.0)\n","Requirement already satisfied: preshed<3.1.0,>=3.0.2 in /usr/local/lib/python3.7/dist-packages (from spacy[cuda111,transformers]) (3.0.6)\n","Requirement already satisfied: requests<3.0.0,>=2.13.0 in /usr/local/lib/python3.7/dist-packages (from spacy[cuda111,transformers]) (2.23.0)\n","Requirement already satisfied: srsly<3.0.0,>=2.4.1 in /usr/local/lib/python3.7/dist-packages (from spacy[cuda111,transformers]) (2.4.2)\n","Requirement already satisfied: packaging>=20.0 in /usr/local/lib/python3.7/dist-packages (from spacy[cuda111,transformers]) (21.3)\n","Requirement already satisfied: pydantic!=1.8,!=1.8.1,<1.9.0,>=1.7.4 in /usr/local/lib/python3.7/dist-packages (from spacy[cuda111,transformers]) (1.8.2)\n","Collecting spacy-transformers<1.2.0,>=1.1.2\n","  Downloading spacy_transformers-1.1.3-py2.py3-none-any.whl (51 kB)\n","\u001b[K     |████████████████████████████████| 51 kB 126 kB/s \n","\u001b[?25hRequirement already satisfied: cupy-cuda111<10.0.0,>=5.0.0b4 in /usr/local/lib/python3.7/dist-packages (from spacy[cuda111,transformers]) (9.4.0)\n","Requirement already satisfied: zipp>=0.5 in /usr/local/lib/python3.7/dist-packages (from catalogue<2.1.0,>=2.0.6->spacy[cuda111,transformers]) (3.6.0)\n","Requirement already satisfied: fastrlock>=0.5 in /usr/local/lib/python3.7/dist-packages (from cupy-cuda111<10.0.0,>=5.0.0b4->spacy[cuda111,transformers]) (0.8)\n","Requirement already satisfied: pyparsing!=3.0.5,>=2.0.2 in /usr/local/lib/python3.7/dist-packages (from packaging>=20.0->spacy[cuda111,transformers]) (3.0.6)\n","Requirement already satisfied: smart-open<6.0.0,>=5.0.0 in /usr/local/lib/python3.7/dist-packages (from pathy>=0.3.5->spacy[cuda111,transformers]) (5.2.1)\n","Requirement already satisfied: certifi>=2017.4.17 in /usr/local/lib/python3.7/dist-packages (from requests<3.0.0,>=2.13.0->spacy[cuda111,transformers]) (2021.10.8)\n","Requirement already satisfied: urllib3!=1.25.0,!=1.25.1,<1.26,>=1.21.1 in /usr/local/lib/python3.7/dist-packages (from requests<3.0.0,>=2.13.0->spacy[cuda111,transformers]) (1.24.3)\n","Requirement already satisfied: chardet<4,>=3.0.2 in /usr/local/lib/python3.7/dist-packages (from requests<3.0.0,>=2.13.0->spacy[cuda111,transformers]) (3.0.4)\n","Requirement already satisfied: idna<3,>=2.5 in /usr/local/lib/python3.7/dist-packages (from requests<3.0.0,>=2.13.0->spacy[cuda111,transformers]) (2.10)\n","Collecting spacy-alignments<1.0.0,>=0.7.2\n","  Downloading spacy_alignments-0.8.4-cp37-cp37m-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (1.1 MB)\n","\u001b[K     |████████████████████████████████| 1.1 MB 8.4 MB/s \n","\u001b[?25hRequirement already satisfied: torch>=1.6.0 in /usr/local/lib/python3.7/dist-packages (from spacy-transformers<1.2.0,>=1.1.2->spacy[cuda111,transformers]) (1.10.0+cu111)\n","Collecting transformers<4.13.0,>=3.4.0\n","  Downloading transformers-4.12.5-py3-none-any.whl (3.1 MB)\n","\u001b[K     |████████████████████████████████| 3.1 MB 44.8 MB/s \n","\u001b[?25hCollecting tokenizers<0.11,>=0.10.1\n","  Downloading tokenizers-0.10.3-cp37-cp37m-manylinux_2_5_x86_64.manylinux1_x86_64.manylinux_2_12_x86_64.manylinux2010_x86_64.whl (3.3 MB)\n","\u001b[K     |████████████████████████████████| 3.3 MB 32.6 MB/s \n","\u001b[?25hCollecting pyyaml>=5.1\n","  Downloading PyYAML-6.0-cp37-cp37m-manylinux_2_5_x86_64.manylinux1_x86_64.manylinux_2_12_x86_64.manylinux2010_x86_64.whl (596 kB)\n","\u001b[K     |████████████████████████████████| 596 kB 42.0 MB/s \n","\u001b[?25hCollecting sacremoses\n","  Downloading sacremoses-0.0.46-py3-none-any.whl (895 kB)\n","\u001b[K     |████████████████████████████████| 895 kB 31.1 MB/s \n","\u001b[?25hRequirement already satisfied: filelock in /usr/local/lib/python3.7/dist-packages (from transformers<4.13.0,>=3.4.0->spacy-transformers<1.2.0,>=1.1.2->spacy[cuda111,transformers]) (3.4.0)\n","Requirement already satisfied: importlib-metadata in /usr/local/lib/python3.7/dist-packages (from transformers<4.13.0,>=3.4.0->spacy-transformers<1.2.0,>=1.1.2->spacy[cuda111,transformers]) (4.8.2)\n","Requirement already satisfied: regex!=2019.12.17 in /usr/local/lib/python3.7/dist-packages (from transformers<4.13.0,>=3.4.0->spacy-transformers<1.2.0,>=1.1.2->spacy[cuda111,transformers]) (2019.12.20)\n","Collecting huggingface-hub<1.0,>=0.1.0\n","  Downloading huggingface_hub-0.2.1-py3-none-any.whl (61 kB)\n","\u001b[K     |████████████████████████████████| 61 kB 488 kB/s \n","\u001b[?25hRequirement already satisfied: click<9.0.0,>=7.1.1 in /usr/local/lib/python3.7/dist-packages (from typer<0.5.0,>=0.3.0->spacy[cuda111,transformers]) (7.1.2)\n","Requirement already satisfied: MarkupSafe>=0.23 in /usr/local/lib/python3.7/dist-packages (from jinja2->spacy[cuda111,transformers]) (2.0.1)\n","Requirement already satisfied: six in /usr/local/lib/python3.7/dist-packages (from sacremoses->transformers<4.13.0,>=3.4.0->spacy-transformers<1.2.0,>=1.1.2->spacy[cuda111,transformers]) (1.15.0)\n","Requirement already satisfied: joblib in /usr/local/lib/python3.7/dist-packages (from sacremoses->transformers<4.13.0,>=3.4.0->spacy-transformers<1.2.0,>=1.1.2->spacy[cuda111,transformers]) (1.1.0)\n","Installing collected packages: pyyaml, tokenizers, sacremoses, huggingface-hub, transformers, spacy-alignments, spacy-transformers\n","  Attempting uninstall: pyyaml\n","    Found existing installation: PyYAML 3.13\n","    Uninstalling PyYAML-3.13:\n","      Successfully uninstalled PyYAML-3.13\n","Successfully installed huggingface-hub-0.2.1 pyyaml-6.0 sacremoses-0.0.46 spacy-alignments-0.8.4 spacy-transformers-1.1.3 tokenizers-0.10.3 transformers-4.12.5\n"]}],"source":["!pip install --upgrade spacy\n","!pip install spacy[transformers,cuda111]"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"C7ciT3UyDLpE"},"outputs":[],"source":["# import libraries\n","import pandas as pd\n","import numpy as np\n","from google.colab import drive\n","import os\n","import ast\n","import spacy\n","from spacy import displacy\n","from tqdm.notebook import tqdm"]},{"cell_type":"markdown","metadata":{"id":"DjQw2-vLF9g2"},"source":["### Load data"]},{"cell_type":"code","execution_count":null,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"elapsed":24267,"status":"ok","timestamp":1639669363160,"user":{"displayName":"Jake Rutherford","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"06919904590009580026"},"user_tz":0},"id":"5IMxanGvGPhr","outputId":"c4a58e07-8470-4ce5-f186-0a322e6a6f9b"},"outputs":[{"output_type":"stream","name":"stdout","text":["Mounted at /content/drive\n"]}],"source":["drive.mount('/content/drive')"]},{"cell_type":"code","execution_count":null,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"elapsed":3340,"status":"ok","timestamp":1639669366496,"user":{"displayName":"Jake Rutherford","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"06919904590009580026"},"user_tz":0},"id":"EMiv4TAGGAaY","outputId":"f944a2a6-36c2-4beb-c18c-f7879f4ed385"},"outputs":[{"output_type":"execute_result","data":{"text/plain":["['NER_data_combined_BREAKDOWN.xlsx',\n"," 'label_map_09062020_more_ents.json',\n"," 'label_map_12062020_more_ents.json',\n"," 'line_by_line_NER_data_sampled_09062020_more_ents.csv',\n"," 'line_by_line_NER_data_sampled_12062020_more_ents.csv',\n"," 'line_by_line_NER_data_sampled.csv',\n"," 'govuk-labelled-data-ner.csv',\n"," 'new_label_map.json',\n"," 'hf_govuk_data',\n"," 'line_by_line_NER_data_combined.csv',\n"," 'un_ner_data',\n"," 'samp_hf_govuk_data',\n"," 'IO-annotation_scheme']"]},"metadata":{},"execution_count":5}],"source":["DATA_DIR = 'drive/Shareddrives/GOV.UK teams/2020-2021/Data labs/content-metadata-2021/Data'\n","os.listdir(DATA_DIR)"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"Y16ieRqxGSSy"},"outputs":[],"source":["df = pd.read_csv(DATA_DIR + '/govuk-labelled-data-ner.csv')"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"jPt7FWd1Nq_L"},"outputs":[],"source":["# some columns are string literals and need to be converted back to lists\n","literals = ['text_token','labels','label_list','new_label_list_id']\n","df[literals] = df[literals].applymap(ast.literal_eval)"]},{"cell_type":"code","execution_count":null,"metadata":{"colab":{"base_uri":"https://localhost:8080/","height":406},"executionInfo":{"elapsed":17,"status":"ok","timestamp":1639670943732,"user":{"displayName":"Jake Rutherford","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"06919904590009580026"},"user_tz":0},"id":"FgZrVx90IOUM","outputId":"600e1c7d-abc1-447c-a1a0-ab0f6c2d1640"},"outputs":[{"output_type":"execute_result","data":{"text/html":["<div>\n","<style scoped>\n","    .dataframe tbody tr th:only-of-type {\n","        vertical-align: middle;\n","    }\n","\n","    .dataframe tbody tr th {\n","        vertical-align: top;\n","    }\n","\n","    .dataframe thead th {\n","        text-align: right;\n","    }\n","</style>\n","<table border=\"1\" class=\"dataframe\">\n","  <thead>\n","    <tr style=\"text-align: right;\">\n","      <th></th>\n","      <th>text</th>\n","      <th>text_token</th>\n","      <th>labels</th>\n","      <th>updated</th>\n","      <th>original_labels</th>\n","      <th>base_path</th>\n","      <th>sampled</th>\n","      <th>label_list</th>\n","      <th>original_file</th>\n","      <th>new_label_list_id</th>\n","    </tr>\n","  </thead>\n","  <tbody>\n","    <tr>\n","      <th>331775</th>\n","      <td>Residents and visitors are required to hold a ...</td>\n","      <td>[Residents, and, visitors, are, required, to, ...</td>\n","      <td>[[0, 9, PERSON], [14, 22, PERSON], [46, 51, ST...</td>\n","      <td>NaN</td>\n","      <td>NaN</td>\n","      <td>/guidance/living-in-st-lucia</td>\n","      <td>True</td>\n","      <td>[PERSON, O, PERSON, O, O, O, O, O, STATE, O, O...</td>\n","      <td>line_by_line_NER_data_sampled_12062020_more_en...</td>\n","      <td>[10, 0, 10, 0, 0, 0, 0, 0, 12, 0, 0, 5, 0, 7, 0]</td>\n","    </tr>\n","    <tr>\n","      <th>172424</th>\n","      <td>'Ready Reckoner ' clinical commissioning group...</td>\n","      <td>['Ready, Reckoner, ', clinical, commissioning,...</td>\n","      <td>[[41, 47, PERSON], [48, 61, FINANCE]]</td>\n","      <td>NaN</td>\n","      <td>NaN</td>\n","      <td>/government/publications/ready-reckoner-clinic...</td>\n","      <td>True</td>\n","      <td>[O, O, O, O, O, PERSON, FINANCE, FINANCE, O, O]</td>\n","      <td>line_by_line_NER_data_sampled_12062020_more_en...</td>\n","      <td>[0, 0, 0, 0, 0, 10, 4, 4, 0, 0]</td>\n","    </tr>\n","    <tr>\n","      <th>199284</th>\n","      <td>Since 2010 the information collected by the in...</td>\n","      <td>[Since, 2010, the, information, collected, by,...</td>\n","      <td>[[6, 10, DATE], [15, 26, CONTACT], [90, 97, MI...</td>\n","      <td>NaN</td>\n","      <td>NaN</td>\n","      <td>/guidance/structure-of-the-agricultural-indust...</td>\n","      <td>True</td>\n","      <td>[O, DATE, O, CONTACT, O, O, O, O, O, O, O, O, ...</td>\n","      <td>line_by_line_NER_data_sampled_12062020_more_en...</td>\n","      <td>[0, 2, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, ...</td>\n","    </tr>\n","  </tbody>\n","</table>\n","</div>"],"text/plain":["                                                     text  ...                                  new_label_list_id\n","331775  Residents and visitors are required to hold a ...  ...   [10, 0, 10, 0, 0, 0, 0, 0, 12, 0, 0, 5, 0, 7, 0]\n","172424  'Ready Reckoner ' clinical commissioning group...  ...                    [0, 0, 0, 0, 0, 10, 4, 4, 0, 0]\n","199284  Since 2010 the information collected by the in...  ...  [0, 2, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, ...\n","\n","[3 rows x 10 columns]"]},"metadata":{},"execution_count":27}],"source":["df.sample(3)"]},{"cell_type":"markdown","metadata":{"id":"DXSxOE7f3O6n"},"source":["## Spacy"]},{"cell_type":"markdown","metadata":{"id":"NJ99NDzqTvpi"},"source":["Spacy utilises Roberta-base in their NER model. On first impression, it shows the potential for identifying language specific to the UK government."]},{"cell_type":"code","execution_count":null,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"elapsed":46055,"status":"ok","timestamp":1639569372626,"user":{"displayName":"Jake Rutherford","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"06919904590009580026"},"user_tz":0},"id":"YUbgAVCA_8Qm","outputId":"a6e6f66a-c79e-42d2-d413-a2a59e0a42be"},"outputs":[{"name":"stdout","output_type":"stream","text":["Collecting en-core-web-trf==3.2.0\n","  Downloading https://github.com/explosion/spacy-models/releases/download/en_core_web_trf-3.2.0/en_core_web_trf-3.2.0-py3-none-any.whl (460.2 MB)\n","\u001b[K     |████████████████████████████████| 460.2 MB 32 kB/s \n","\u001b[?25hRequirement already satisfied: spacy<3.3.0,>=3.2.0 in /usr/local/lib/python3.7/dist-packages (from en-core-web-trf==3.2.0) (3.2.1)\n","Requirement already satisfied: spacy-transformers<1.2.0,>=1.1.2 in /usr/local/lib/python3.7/dist-packages (from en-core-web-trf==3.2.0) (1.1.3)\n","Requirement already satisfied: packaging>=20.0 in /usr/local/lib/python3.7/dist-packages (from spacy<3.3.0,>=3.2.0->en-core-web-trf==3.2.0) (21.3)\n","Requirement already satisfied: murmurhash<1.1.0,>=0.28.0 in /usr/local/lib/python3.7/dist-packages (from spacy<3.3.0,>=3.2.0->en-core-web-trf==3.2.0) (1.0.6)\n","Requirement already satisfied: typing-extensions<4.0.0.0,>=3.7.4 in /usr/local/lib/python3.7/dist-packages (from spacy<3.3.0,>=3.2.0->en-core-web-trf==3.2.0) (3.10.0.2)\n","Requirement already satisfied: thinc<8.1.0,>=8.0.12 in /usr/local/lib/python3.7/dist-packages (from spacy<3.3.0,>=3.2.0->en-core-web-trf==3.2.0) (8.0.13)\n","Requirement already satisfied: spacy-loggers<2.0.0,>=1.0.0 in /usr/local/lib/python3.7/dist-packages (from spacy<3.3.0,>=3.2.0->en-core-web-trf==3.2.0) (1.0.1)\n","Requirement already satisfied: requests<3.0.0,>=2.13.0 in /usr/local/lib/python3.7/dist-packages (from spacy<3.3.0,>=3.2.0->en-core-web-trf==3.2.0) (2.23.0)\n","Requirement already satisfied: setuptools in /usr/local/lib/python3.7/dist-packages (from spacy<3.3.0,>=3.2.0->en-core-web-trf==3.2.0) (57.4.0)\n","Requirement already satisfied: spacy-legacy<3.1.0,>=3.0.8 in /usr/local/lib/python3.7/dist-packages (from spacy<3.3.0,>=3.2.0->en-core-web-trf==3.2.0) (3.0.8)\n","Requirement already satisfied: srsly<3.0.0,>=2.4.1 in /usr/local/lib/python3.7/dist-packages (from spacy<3.3.0,>=3.2.0->en-core-web-trf==3.2.0) (2.4.2)\n","Requirement already satisfied: catalogue<2.1.0,>=2.0.6 in /usr/local/lib/python3.7/dist-packages (from spacy<3.3.0,>=3.2.0->en-core-web-trf==3.2.0) (2.0.6)\n","Requirement already satisfied: preshed<3.1.0,>=3.0.2 in /usr/local/lib/python3.7/dist-packages (from spacy<3.3.0,>=3.2.0->en-core-web-trf==3.2.0) (3.0.6)\n","Requirement already satisfied: typer<0.5.0,>=0.3.0 in /usr/local/lib/python3.7/dist-packages (from spacy<3.3.0,>=3.2.0->en-core-web-trf==3.2.0) (0.4.0)\n","Requirement already satisfied: jinja2 in /usr/local/lib/python3.7/dist-packages (from spacy<3.3.0,>=3.2.0->en-core-web-trf==3.2.0) (2.11.3)\n","Requirement already satisfied: cymem<2.1.0,>=2.0.2 in /usr/local/lib/python3.7/dist-packages (from spacy<3.3.0,>=3.2.0->en-core-web-trf==3.2.0) (2.0.6)\n","Requirement already satisfied: wasabi<1.1.0,>=0.8.1 in /usr/local/lib/python3.7/dist-packages (from spacy<3.3.0,>=3.2.0->en-core-web-trf==3.2.0) (0.8.2)\n","Requirement already satisfied: pathy>=0.3.5 in /usr/local/lib/python3.7/dist-packages (from spacy<3.3.0,>=3.2.0->en-core-web-trf==3.2.0) (0.6.1)\n","Requirement already satisfied: pydantic!=1.8,!=1.8.1,<1.9.0,>=1.7.4 in /usr/local/lib/python3.7/dist-packages (from spacy<3.3.0,>=3.2.0->en-core-web-trf==3.2.0) (1.8.2)\n","Requirement already satisfied: tqdm<5.0.0,>=4.38.0 in /usr/local/lib/python3.7/dist-packages (from spacy<3.3.0,>=3.2.0->en-core-web-trf==3.2.0) (4.62.3)\n","Requirement already satisfied: blis<0.8.0,>=0.4.0 in /usr/local/lib/python3.7/dist-packages (from spacy<3.3.0,>=3.2.0->en-core-web-trf==3.2.0) (0.4.1)\n","Requirement already satisfied: numpy>=1.15.0 in /usr/local/lib/python3.7/dist-packages (from spacy<3.3.0,>=3.2.0->en-core-web-trf==3.2.0) (1.19.5)\n","Requirement already satisfied: langcodes<4.0.0,>=3.2.0 in /usr/local/lib/python3.7/dist-packages (from spacy<3.3.0,>=3.2.0->en-core-web-trf==3.2.0) (3.3.0)\n","Requirement already satisfied: zipp>=0.5 in /usr/local/lib/python3.7/dist-packages (from catalogue<2.1.0,>=2.0.6->spacy<3.3.0,>=3.2.0->en-core-web-trf==3.2.0) (3.6.0)\n","Requirement already satisfied: pyparsing!=3.0.5,>=2.0.2 in /usr/local/lib/python3.7/dist-packages (from packaging>=20.0->spacy<3.3.0,>=3.2.0->en-core-web-trf==3.2.0) (3.0.6)\n","Requirement already satisfied: smart-open<6.0.0,>=5.0.0 in /usr/local/lib/python3.7/dist-packages (from pathy>=0.3.5->spacy<3.3.0,>=3.2.0->en-core-web-trf==3.2.0) (5.2.1)\n","Requirement already satisfied: certifi>=2017.4.17 in /usr/local/lib/python3.7/dist-packages (from requests<3.0.0,>=2.13.0->spacy<3.3.0,>=3.2.0->en-core-web-trf==3.2.0) (2021.10.8)\n","Requirement already satisfied: urllib3!=1.25.0,!=1.25.1,<1.26,>=1.21.1 in /usr/local/lib/python3.7/dist-packages (from requests<3.0.0,>=2.13.0->spacy<3.3.0,>=3.2.0->en-core-web-trf==3.2.0) (1.24.3)\n","Requirement already satisfied: idna<3,>=2.5 in /usr/local/lib/python3.7/dist-packages (from requests<3.0.0,>=2.13.0->spacy<3.3.0,>=3.2.0->en-core-web-trf==3.2.0) (2.10)\n","Requirement already satisfied: chardet<4,>=3.0.2 in /usr/local/lib/python3.7/dist-packages (from requests<3.0.0,>=2.13.0->spacy<3.3.0,>=3.2.0->en-core-web-trf==3.2.0) (3.0.4)\n","Requirement already satisfied: spacy-alignments<1.0.0,>=0.7.2 in /usr/local/lib/python3.7/dist-packages (from spacy-transformers<1.2.0,>=1.1.2->en-core-web-trf==3.2.0) (0.8.4)\n","Requirement already satisfied: torch>=1.6.0 in /usr/local/lib/python3.7/dist-packages (from spacy-transformers<1.2.0,>=1.1.2->en-core-web-trf==3.2.0) (1.10.0+cu111)\n","Requirement already satisfied: transformers<4.13.0,>=3.4.0 in /usr/local/lib/python3.7/dist-packages (from spacy-transformers<1.2.0,>=1.1.2->en-core-web-trf==3.2.0) (4.12.5)\n","Requirement already satisfied: sacremoses in /usr/local/lib/python3.7/dist-packages (from transformers<4.13.0,>=3.4.0->spacy-transformers<1.2.0,>=1.1.2->en-core-web-trf==3.2.0) (0.0.46)\n","Requirement already satisfied: tokenizers<0.11,>=0.10.1 in /usr/local/lib/python3.7/dist-packages (from transformers<4.13.0,>=3.4.0->spacy-transformers<1.2.0,>=1.1.2->en-core-web-trf==3.2.0) (0.10.3)\n","Requirement already satisfied: regex!=2019.12.17 in /usr/local/lib/python3.7/dist-packages (from transformers<4.13.0,>=3.4.0->spacy-transformers<1.2.0,>=1.1.2->en-core-web-trf==3.2.0) (2019.12.20)\n","Requirement already satisfied: importlib-metadata in /usr/local/lib/python3.7/dist-packages (from transformers<4.13.0,>=3.4.0->spacy-transformers<1.2.0,>=1.1.2->en-core-web-trf==3.2.0) (4.8.2)\n","Requirement already satisfied: filelock in /usr/local/lib/python3.7/dist-packages (from transformers<4.13.0,>=3.4.0->spacy-transformers<1.2.0,>=1.1.2->en-core-web-trf==3.2.0) (3.4.0)\n","Requirement already satisfied: pyyaml>=5.1 in /usr/local/lib/python3.7/dist-packages (from transformers<4.13.0,>=3.4.0->spacy-transformers<1.2.0,>=1.1.2->en-core-web-trf==3.2.0) (6.0)\n","Requirement already satisfied: huggingface-hub<1.0,>=0.1.0 in /usr/local/lib/python3.7/dist-packages (from transformers<4.13.0,>=3.4.0->spacy-transformers<1.2.0,>=1.1.2->en-core-web-trf==3.2.0) (0.2.1)\n","Requirement already satisfied: click<9.0.0,>=7.1.1 in /usr/local/lib/python3.7/dist-packages (from typer<0.5.0,>=0.3.0->spacy<3.3.0,>=3.2.0->en-core-web-trf==3.2.0) (7.1.2)\n","Requirement already satisfied: MarkupSafe>=0.23 in /usr/local/lib/python3.7/dist-packages (from jinja2->spacy<3.3.0,>=3.2.0->en-core-web-trf==3.2.0) (2.0.1)\n","Requirement already satisfied: joblib in /usr/local/lib/python3.7/dist-packages (from sacremoses->transformers<4.13.0,>=3.4.0->spacy-transformers<1.2.0,>=1.1.2->en-core-web-trf==3.2.0) (1.1.0)\n","Requirement already satisfied: six in /usr/local/lib/python3.7/dist-packages (from sacremoses->transformers<4.13.0,>=3.4.0->spacy-transformers<1.2.0,>=1.1.2->en-core-web-trf==3.2.0) (1.15.0)\n","Installing collected packages: en-core-web-trf\n","Successfully installed en-core-web-trf-3.2.0\n","\u001b[38;5;2m✔ Download and installation successful\u001b[0m\n","You can now load the package via spacy.load('en_core_web_trf')\n"]}],"source":["!python -m spacy download en_core_web_trf"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"Pe3arRRS_5Pa"},"outputs":[],"source":["import en_core_web_trf\n","nlp = en_core_web_trf.load()"]},{"cell_type":"code","execution_count":null,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"elapsed":383,"status":"ok","timestamp":1639569377527,"user":{"displayName":"Jake Rutherford","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"06919904590009580026"},"user_tz":0},"id":"7sKg06wQ4FQ2","outputId":"eff57fc4-7a66-4a57-e13d-3b599ff06022"},"outputs":[{"data":{"text/html":["<span class=\"tex2jax_ignore\"><div class=\"entities\" style=\"line-height: 2.5; direction: ltr\">\n","<mark class=\"entity\" style=\"background: #ff8197; padding: 0.45em 0.6em; margin: 0 0.25em; line-height: 1; border-radius: 0.35em;\">\n","    This Framework Agreement\n","    <span style=\"font-size: 0.8em; font-weight: bold; line-height: 1; border-radius: 0.35em; vertical-align: middle; margin-left: 0.5rem\">LAW</span>\n","</mark>\n"," describes the primary elements of how the \n","<mark class=\"entity\" style=\"background: #7aecec; padding: 0.45em 0.6em; margin: 0 0.25em; line-height: 1; border-radius: 0.35em;\">\n","    CDEI\n","    <span style=\"font-size: 0.8em; font-weight: bold; line-height: 1; border-radius: 0.35em; vertical-align: middle; margin-left: 0.5rem\">ORG</span>\n","</mark>\n"," and \n","<mark class=\"entity\" style=\"background: #7aecec; padding: 0.45em 0.6em; margin: 0 0.25em; line-height: 1; border-radius: 0.35em;\">\n","    DCMS\n","    <span style=\"font-size: 0.8em; font-weight: bold; line-height: 1; border-radius: 0.35em; vertical-align: middle; margin-left: 0.5rem\">ORG</span>\n","</mark>\n"," will work together during the \n","<mark class=\"entity\" style=\"background: #7aecec; padding: 0.45em 0.6em; margin: 0 0.25em; line-height: 1; border-radius: 0.35em;\">\n","    CDEI\n","    <span style=\"font-size: 0.8em; font-weight: bold; line-height: 1; border-radius: 0.35em; vertical-align: middle; margin-left: 0.5rem\">ORG</span>\n","</mark>\n"," ’ s pre-statutory phase .</div></span>"],"text/plain":["<IPython.core.display.HTML object>"]},"metadata":{},"output_type":"display_data"}],"source":["i = 13904\n","doc = nlp(df.text[i])\n","displacy.render(doc, style=\"ent\", jupyter=True)"]},{"cell_type":"markdown","metadata":{"id":"W8IFfu4fS5bC"},"source":["This model finds the following named entities:\n","\n","Source https://spacy.io/models/en#en_core_web_trf"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"YlsqrMrOFpIr"},"outputs":[],"source":["spacy_ents = ['CARDINAL', 'DATE', 'EVENT', 'FAC', 'GPE', 'LANGUAGE', 'LAW', 'LOC', 'MONEY', 'NORP', 'ORDINAL', 'ORG', 'PERCENT', 'PERSON', 'PRODUCT', 'QUANTITY', 'TIME', 'WORK_OF_ART']"]},{"cell_type":"code","execution_count":null,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"elapsed":14,"status":"ok","timestamp":1639569377528,"user":{"displayName":"Jake Rutherford","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"06919904590009580026"},"user_tz":0},"id":"4cRbtsAyJD_r","outputId":"3907f88c-5da2-454d-be7e-2cf43b65df3d"},"outputs":[{"name":"stdout","output_type":"stream","text":["CARDINAL :  Numerals that do not fall under another type\n","DATE :  Absolute or relative dates or periods\n","EVENT :  Named hurricanes, battles, wars, sports events, etc.\n","FAC :  Buildings, airports, highways, bridges, etc.\n","GPE :  Countries, cities, states\n","LANGUAGE :  Any named language\n","LAW :  Named documents made into laws.\n","LOC :  Non-GPE locations, mountain ranges, bodies of water\n","MONEY :  Monetary values, including unit\n","NORP :  Nationalities or religious or political groups\n","ORDINAL :  \"first\", \"second\", etc.\n","ORG :  Companies, agencies, institutions, etc.\n","PERCENT :  Percentage, including \"%\"\n","PERSON :  People, including fictional\n","PRODUCT :  Objects, vehicles, foods, etc. (not services)\n","QUANTITY :  Measurements, as of weight or distance\n","TIME :  Times smaller than a day\n","WORK_OF_ART :  Titles of books, songs, etc.\n"]}],"source":["for ent in spacy_ents:\n","  print(ent, ': ', spacy.explain(ent))"]},{"cell_type":"markdown","metadata":{"id":"_OBzzECvWqI3"},"source":["By contrast, our schema is:\n","\n"]},{"cell_type":"code","execution_count":null,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"elapsed":423,"status":"ok","timestamp":1639569377947,"user":{"displayName":"Jake Rutherford","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"06919904590009580026"},"user_tz":0},"id":"Tgb79yldXRks","outputId":"a13c3c9b-3ba1-42ee-ce2c-bfcec0d5aabd"},"outputs":[{"data":{"text/plain":["{'CONTACT',\n"," 'DATE',\n"," 'EVENT',\n"," 'FINANCE',\n"," 'FORM',\n"," 'LOCATION',\n"," 'MISC',\n"," 'MONEY',\n"," 'O',\n"," 'ORGANIZATION',\n"," 'PERSON',\n"," 'SCHEME',\n"," 'STATE'}"]},"execution_count":14,"metadata":{},"output_type":"execute_result"}],"source":["{label for labels in df.label_list for label in labels}"]},{"cell_type":"markdown","metadata":{"id":"-nTzwxidXxjL"},"source":["Some of these map directly to the SpaCy schema. Some do not have an equivalent in the SpaCy schema. Where there is not a direct mapping, we will map to 'O'."]},{"cell_type":"code","execution_count":null,"metadata":{"id":"ZULSkDGBYOVQ"},"outputs":[],"source":["# mappings from the govNER labelling exercise to the spacy schema\n","gov2spacy = {\n","    'CONTACT': 'O',\n","    'DATE': 'DATE',\n","    'EVENT': 'EVENT',\n","    'FINANCE': 'O',\n","    'FORM': 'O',\n","    'LOCATION': 'GPE',\n","    'MISC': 'O',\n","    'MONEY': 'MONEY',\n","    'O':'O',\n","    'ORGANIZATION': 'ORG',\n","    'PERSON': 'PERSON',\n","    'SCHEME': 'O',\n","    'STATE': 'O',\n","}\n","\n","# mappings from the spacy schema to the govNER schema\n","spacy2gov = {\n","    'CARDINAL':\n","    'DATE',\n","    'EVENT',\n","    'FAC',\n","    'GPE',\n","    'LANGUAGE',\n","    'LAW',\n","    'LOC',\n","    'MONEY',\n","    'NORP',\n","    'ORDINAL',\n","    'ORG',\n","    'PERCENT',\n","    'PERSON',\n","    'PRODUCT',\n","    'QUANTITY',\n","    'TIME',\n","    'WORK_OF_ART'\n","}"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"aliWidOra-Bz"},"outputs":[],"source":["df['spacy_labels'] = df.label_list.apply(lambda x: [gov2spacy[label] for label in x])"]},{"cell_type":"code","execution_count":null,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"elapsed":5,"status":"ok","timestamp":1639569379328,"user":{"displayName":"Jake Rutherford","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"06919904590009580026"},"user_tz":0},"id":"KSd3BZC_btnZ","outputId":"a6edc17d-d3c2-49af-81e9-db63175789af"},"outputs":[{"data":{"text/html":["<div>\n","<style scoped>\n","    .dataframe tbody tr th:only-of-type {\n","        vertical-align: middle;\n","    }\n","\n","    .dataframe tbody tr th {\n","        vertical-align: top;\n","    }\n","\n","    .dataframe thead th {\n","        text-align: right;\n","    }\n","</style>\n","<table border=\"1\" class=\"dataframe\">\n","  <thead>\n","    <tr style=\"text-align: right;\">\n","      <th></th>\n","      <th>text</th>\n","      <th>text_token</th>\n","      <th>labels</th>\n","      <th>updated</th>\n","      <th>original_labels</th>\n","      <th>base_path</th>\n","      <th>sampled</th>\n","      <th>label_list</th>\n","      <th>original_file</th>\n","      <th>new_label_list_id</th>\n","      <th>spacy_labels</th>\n","    </tr>\n","  </thead>\n","  <tbody>\n","    <tr>\n","      <th>0</th>\n","      <td>However , to be clear , all of the other check...</td>\n","      <td>[However, ,, to, be, clear, ,, all, of, the, o...</td>\n","      <td>[[41, 47, EVENT], [81, 90, PERSON]]</td>\n","      <td>NaN</td>\n","      <td>NaN</td>\n","      <td>/government/speeches/business-secretarys-state...</td>\n","      <td>True</td>\n","      <td>[O, O, O, O, O, O, O, O, O, O, EVENT, O, O, O,...</td>\n","      <td>line_by_line_NER_data_sampled_12062020_more_en...</td>\n","      <td>[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, ...</td>\n","      <td>[O, O, O, O, O, O, O, O, O, O, EVENT, O, O, O,...</td>\n","    </tr>\n","    <tr>\n","      <th>1</th>\n","      <td>Organisations that met certain criteria during...</td>\n","      <td>[Organisations, that, met, certain, criteria, ...</td>\n","      <td>[[65, 69, DATE], [77, 85, FORM]]</td>\n","      <td>NaN</td>\n","      <td>NaN</td>\n","      <td>/guidance/crc-energy-efficiency-scheme-qualifi...</td>\n","      <td>True</td>\n","      <td>[O, O, O, O, O, O, O, O, DATE, O, O, FORM, O, ...</td>\n","      <td>line_by_line_NER_data_sampled_09062020_more_en...</td>\n","      <td>[0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 5, 0, 0, 0, ...</td>\n","      <td>[O, O, O, O, O, O, O, O, DATE, O, O, O, O, O, ...</td>\n","    </tr>\n","    <tr>\n","      <th>2</th>\n","      <td>Use this leaflet and form to find out about pa...</td>\n","      <td>[Use, this, leaflet, and, form, to, find, out,...</td>\n","      <td>[[21, 25, FORM], [44, 50, FINANCE], [51, 83, F...</td>\n","      <td>NaN</td>\n","      <td>NaN</td>\n","      <td>/government/publications/social-security-abroa...</td>\n","      <td>True</td>\n","      <td>[O, O, O, O, FORM, O, O, O, O, FINANCE, FINANC...</td>\n","      <td>line_by_line_NER_data_sampled_12062020_more_en...</td>\n","      <td>[0, 0, 0, 0, 5, 0, 0, 0, 0, 4, 4, 4, 4, 0, 6, ...</td>\n","      <td>[O, O, O, O, O, O, O, O, O, O, O, O, O, O, GPE...</td>\n","    </tr>\n","    <tr>\n","      <th>3</th>\n","      <td>Legal visits must be booked by email : legalvi...</td>\n","      <td>[Legal, visits, must, be, booked, by, email, :...</td>\n","      <td>[[31, 36, CONTACT], [82, 94, PERSON], [103, 10...</td>\n","      <td>NaN</td>\n","      <td>NaN</td>\n","      <td>/guidance/liverpool-prison</td>\n","      <td>True</td>\n","      <td>[O, O, O, O, O, O, CONTACT, O, O, O, O, O, PER...</td>\n","      <td>line_by_line_NER_data_sampled_12062020_more_en...</td>\n","      <td>[0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 10, 10, 0...</td>\n","      <td>[O, O, O, O, O, O, O, O, O, O, O, O, PERSON, P...</td>\n","    </tr>\n","    <tr>\n","      <th>4</th>\n","      <td>RPC checklist for Small and Micro Business Ass...</td>\n","      <td>[RPC, checklist, for, Small, and, Micro, Busin...</td>\n","      <td>[[0, 3, ORGANIZATION], [34, 42, ORGANIZATION],...</td>\n","      <td>NaN</td>\n","      <td>NaN</td>\n","      <td>/government/publications/small-and-micro-busin...</td>\n","      <td>True</td>\n","      <td>[ORGANIZATION, O, O, O, O, O, ORGANIZATION, O,...</td>\n","      <td>line_by_line_NER_data_sampled_12062020_more_en...</td>\n","      <td>[9, 0, 0, 0, 0, 0, 9, 0, 0, 0, 0, 0, 2, 2, 0]</td>\n","      <td>[ORG, O, O, O, O, O, ORG, O, O, O, O, O, DATE,...</td>\n","    </tr>\n","  </tbody>\n","</table>\n","</div>"],"text/plain":["                                                text  ...                                       spacy_labels\n","0  However , to be clear , all of the other check...  ...  [O, O, O, O, O, O, O, O, O, O, EVENT, O, O, O,...\n","1  Organisations that met certain criteria during...  ...  [O, O, O, O, O, O, O, O, DATE, O, O, O, O, O, ...\n","2  Use this leaflet and form to find out about pa...  ...  [O, O, O, O, O, O, O, O, O, O, O, O, O, O, GPE...\n","3  Legal visits must be booked by email : legalvi...  ...  [O, O, O, O, O, O, O, O, O, O, O, O, PERSON, P...\n","4  RPC checklist for Small and Micro Business Ass...  ...  [ORG, O, O, O, O, O, ORG, O, O, O, O, O, DATE,...\n","\n","[5 rows x 11 columns]"]},"execution_count":17,"metadata":{},"output_type":"execute_result"}],"source":["df.head()"]},{"cell_type":"markdown","metadata":{"id":"Z5mc5TJrWhAn"},"source":["### Dirty misc. stuff"]},{"cell_type":"code","execution_count":null,"metadata":{"colab":{"background_save":true,"base_uri":"https://localhost:8080/","height":104,"referenced_widgets":["00a1643c9ea746c2984540e72eb9525a","173b8a879c1c4be380b52587ce9c349a","063715dca5b44ec49fce3319857bbc85","5c8e8bddd7de447fa55156a0d9b48c50","00d6e3c67cec4f8f92ebef48a41aca72","04caa11f654f46139733c8b2ff292a1b","ebeda7bc5f6c45f284eb114f5cb07f2b","ede6080f822a45ab87162145cf3a9b90","a43ac5e1b01643ae804018ebb435a137","2ca57c8d137142b3935b4fb12481e63b","099ff583299b4eab81c853dd4c8291e3"]},"id":"D2ke2W0ALm3u","outputId":"b46455b6-cda9-4e86-b466-3fd98c0a825d"},"outputs":[{"data":{"application/vnd.jupyter.widget-view+json":{"model_id":"00a1643c9ea746c2984540e72eb9525a","version_major":2,"version_minor":0},"text/plain":["  0%|          | 0/5000 [00:00<?, ?it/s]"]},"metadata":{},"output_type":"display_data"},{"name":"stdout","output_type":"stream","text":["Match: the British + High Commission ,in: Accordingly the FCO and the British High Commission Port Louis will not be liable for any inaccuracies in this information .\n","Match: OFT/ + DECC ,in: Green Deal : OFT/ DECC joint guidance for providers .\n","Match: India + India ,in: Information on legal issues relating to parental child abduction Information on legal issues relating to parental child abduction in India India - Child Abduction .\n","Match: 1 + 0 ,in: The U.S. women 's soccer ( football ) team has defeated Sweden , 1-0 , in an Olympic prep match in Skelleftea , Sweden .\n","Match: Calderbridge + Cumbria ,in: LLW Repository Ltd Pelham House Pelham Drive Calderbridge Cumbria CA20 1DB Email nwp @ llwrsite.com Telephone 019467 22740\n","Match: 324 + 34 ,in: Stamp Duty rates : leasehold - on lease premium For rates before 2000 , see the Stamp Taxes Manual appendix C pages 324-34 .\n","Match: chapter 5 of + the RDR3 : Statutory Residence Test ,in: More information on split years and the Statutory Residence Test ( SRT ) can be found in chapter 5 of the RDR3 : Statutory Residence Test .\n","Match: Linda Sloan + Joyce Allen ,in: Linda Sloan Joyce Allen - 07946121910 Department for Transport ( DfT ) .\n","Match: Iraqi + Shi'ite ,in: Meanwhile , Iraqi Shi'ite and Kurdish negotiators seeking agreement on the makeup of a new government are meeting today , before parliament 's next session Wednesday .\n","Match: Sweet and Maxwell ’ s + Criminal Law Review ,in: This article ‘ Forensic science evidence in question ’ was published in Sweet and Maxwell ’ s Criminal Law Review ( Issue 5 , 2011 ) .\n"]}],"source":["# finding multi token entities\n","matches = []\n","sample_df = df.text.sample(5000)\n","for text in tqdm(sample_df):\n","  doc = nlp(text)\n","  if doc.ents:\n","    entities = [[ent.start_char, ent.end_char, ent.label_, ent.text] for ent in doc.ents]\n","    for A, B in zip(entities,entities[1:]):\n","      if (A[1] + 1 == B[0]) and (A[2] == B[2]):\n","        matches.append([doc,A,B])\n","        print('Match:', A[3],'+', B[3], ',in:',doc)"]},{"cell_type":"code","source":["# finding bad labels\n","i = 0\n","screw_up = []\n","for text,labels in zip(df.text, df.labels):\n","  label_pos = [label for labla in labels for label in labla]\n","\n","  if 'pm ' in text and 'MONEY' in label_pos:\n","    screw_up.append([(text[i-3:j+2],x) for i,j,x in labels if x == 'MONEY'])\n","\n","  # if 'MONEY' in label_pos and 'FINANCE' in label_pos:\n","  #   i += 1\n","  #   if i == 822:\n","  #     break\n","\n","print(text)\n","\n","[(text[i:j],x) for i,j,x in labels]"],"metadata":{"id":"XiPirrZvIjFV"},"execution_count":null,"outputs":[]}],"metadata":{"accelerator":"GPU","colab":{"name":"012_SpaCy_NER","provenance":[],"authorship_tag":"ABX9TyN4mtwT3ZODALu3GozM34Fp"},"kernelspec":{"display_name":"Python 3","name":"python3"},"language_info":{"name":"python"},"widgets":{"application/vnd.jupyter.widget-state+json":{"00a1643c9ea746c2984540e72eb9525a":{"model_module":"@jupyter-widgets/controls","model_module_version":"1.5.0","model_name":"HBoxModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"HBoxModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"1.5.0","_view_name":"HBoxView","box_style":"","children":["IPY_MODEL_173b8a879c1c4be380b52587ce9c349a","IPY_MODEL_063715dca5b44ec49fce3319857bbc85","IPY_MODEL_5c8e8bddd7de447fa55156a0d9b48c50"],"layout":"IPY_MODEL_00d6e3c67cec4f8f92ebef48a41aca72"}},"00d6e3c67cec4f8f92ebef48a41aca72":{"model_module":"@jupyter-widgets/base","model_module_version":"1.2.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"1.2.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"overflow_x":null,"overflow_y":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"04caa11f654f46139733c8b2ff292a1b":{"model_module":"@jupyter-widgets/base","model_module_version":"1.2.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"1.2.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"overflow_x":null,"overflow_y":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"063715dca5b44ec49fce3319857bbc85":{"model_module":"@jupyter-widgets/controls","model_module_version":"1.5.0","model_name":"FloatProgressModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"FloatProgressModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"1.5.0","_view_name":"ProgressView","bar_style":"","description":"","description_tooltip":null,"layout":"IPY_MODEL_ede6080f822a45ab87162145cf3a9b90","max":5000,"min":0,"orientation":"horizontal","style":"IPY_MODEL_a43ac5e1b01643ae804018ebb435a137","value":889}},"099ff583299b4eab81c853dd4c8291e3":{"model_module":"@jupyter-widgets/controls","model_module_version":"1.5.0","model_name":"DescriptionStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"DescriptionStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"StyleView","description_width":""}},"173b8a879c1c4be380b52587ce9c349a":{"model_module":"@jupyter-widgets/controls","model_module_version":"1.5.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"1.5.0","_view_name":"HTMLView","description":"","description_tooltip":null,"layout":"IPY_MODEL_04caa11f654f46139733c8b2ff292a1b","placeholder":"​","style":"IPY_MODEL_ebeda7bc5f6c45f284eb114f5cb07f2b","value":" 18%"}},"2ca57c8d137142b3935b4fb12481e63b":{"model_module":"@jupyter-widgets/base","model_module_version":"1.2.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"1.2.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"overflow_x":null,"overflow_y":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"5c8e8bddd7de447fa55156a0d9b48c50":{"model_module":"@jupyter-widgets/controls","model_module_version":"1.5.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"1.5.0","_view_name":"HTMLView","description":"","description_tooltip":null,"layout":"IPY_MODEL_2ca57c8d137142b3935b4fb12481e63b","placeholder":"​","style":"IPY_MODEL_099ff583299b4eab81c853dd4c8291e3","value":" 889/5000 [02:05&lt;08:48,  7.78it/s]"}},"a43ac5e1b01643ae804018ebb435a137":{"model_module":"@jupyter-widgets/controls","model_module_version":"1.5.0","model_name":"ProgressStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"ProgressStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"StyleView","bar_color":null,"description_width":""}},"ebeda7bc5f6c45f284eb114f5cb07f2b":{"model_module":"@jupyter-widgets/controls","model_module_version":"1.5.0","model_name":"DescriptionStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"DescriptionStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"StyleView","description_width":""}},"ede6080f822a45ab87162145cf3a9b90":{"model_module":"@jupyter-widgets/base","model_module_version":"1.2.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"1.2.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"overflow_x":null,"overflow_y":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}}}}},"nbformat":4,"nbformat_minor":0}